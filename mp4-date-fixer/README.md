# MP4 Folder Date Fixer

Утилита для Debian 12, которая рекурсивно обходит папки, находит MP4 файлы и устанавливает их метаданные (CreateDate и др.) в соответствии с датой, указанной в имени родительской папки.

## Особенности
- **Целевое время:** 12:00 MSK (Europe/Moscow) для указанной даты.
- **Совместимость:** Использует `QuickTime:CreateDate` (UTC) и `Keys:CreationDate` (с таймзоной) для корректного отображения в Windows, macOS и iOS.
- **Безопасность:** Создает временный бэкап, верифицирует записанные данные, и только при успехе удаляет бэкап.
- **Идемпотентность:** Если дата уже верна, файл не перезаписывается.

## Требования

Скрипт разработан для **Debian 12 (Bookworm)**.

1. **Python 3.11+** (встроен в систему).
2. **ExifTool** (требуется установка).

### Установка зависимостей

```bash
sudo apt update
# MP4 Folder Date Fixer

Утилита для Debian 12, которая рекурсивно обходит папки, находит MP4 файлы и устанавливает их метаданные (CreateDate и др.) в соответствии с датой, указанной в имени родительской папки.

## Особенности
- **Целевое время:** 12:00 MSK (Europe/Moscow) для указанной даты.
- **Совместимость:** Использует `QuickTime:CreateDate` (UTC) и `Keys:CreationDate` (с таймзоной) для корректного отображения в Windows, macOS и iOS.
- **Безопасность:** Создает временный бэкап, верифицирует записанные данные, и только при успехе удаляет бэкап.
- **Идемпотентность:** Если дата уже верна, файл не перезаписывается.

## Требования

Скрипт разработан для **Debian 12 (Bookworm)**.

1. **Python 3.11+** (встроен в систему).
2. **ExifTool** (требуется установка).

### Установка зависимостей

```bash
sudo apt update
sudo apt install libimage-exiftool-perl python3
```

## Использование

Сделайте скрипт исполняемым:
```bash
chmod +x mp4_folder_date_fixer.py
```

### 1. Тестовый прогон (Dry Run)
Всегда начинайте с этого режима. Он покажет, какие файлы будут изменены, но не тронет их.
```bash
./mp4_folder_date_fixer.py --root /path/to/videos --dry-run --verbose
```

### 2. Реальный запуск (с лимитом)
Рекомендуется сначала проверить на небольшом количестве файлов.
```bash
./mp4_folder_date_fixer.py --root /path/to/videos --limit 5
```

### 3. Полный запуск
```bash
./mp4_folder_date_fixer.py --root /path/to/videos
```

### Аргументы
- `--root PATH`: (Обязательно) Путь к папке с видео.
- `--dry-run`: Только логирование, без изменений.
- `--limit N`: Остановиться после обработки N файлов.
- `--log PATH`: Путь к логу (по умолчанию `./mp4_date_fixer.log`).
- `--timezone`: Временная зона (по умолчанию `Europe/Moscow`).

## Технические детали

### Какие теги меняются?
Скрипт устанавливает следующие теги на `YYYY:MM:DD 12:00:00+03:00` (с учетом конвертации в UTC для QuickTime тегов):
- `QuickTime:CreateDate` / `ModifyDate`
- `QuickTime:TrackCreateDate` / `TrackModifyDate`
- `QuickTime:MediaCreateDate` / `MediaModifyDate`
- `Keys:CreationDate` (для Apple устройств)

### Файловые времена (mtime/ctime)
- **mtime (Modified):** Устанавливается на 12:00 целевой даты.
- **atime (Accessed):** Устанавливается на 12:00 целевой даты.
- **ctime (Changed):** В Linux `ctime` обновляется ядром автоматически при любой записи метаданных. **Его невозможно установить в прошлое** без изменения системных часов. Поэтому `ctime` будет равен времени запуска скрипта.

### Логика конфликтов
Если `QuickTime:CreateDate` уже соответствует целевой дате (12:00 MSK), файл считается корректным и пропускается (даже если другие теги отличаются). Это позволяет сохранить историю редактирования, если она была.
```

### 5. Как протестировать (Checklist)

1.  **Подготовка:**
    Создайте структуру:
    ```text
    test_folder/
      ├── 2023-01-01 New Year/
      │     └── video1.mp4
      └── NoDateFolder/
            └── video2.mp4
    ```
2.  **Dry Run:**
    Запустите с `--dry-run`.
    *Ожидание:* В логе написано `[DRY-RUN] Would execute...` для `video1.mp4`. `video2.mp4` пропущен (нет даты).
3.  **Запуск:**
    Запустите без флагов.
    *Ожидание:* `video1.mp4` обновлен. Появился лог `Success`.
4.  **Проверка:**
    Выполните `exiftool -G1 -a -s test_folder/2023-01-01\ New\ Year/video1.mp4`.
    *Ожидание:* `CreateDate` показывает время, эквивалентное 12:00 MSK (например, `09:00:00` если смотреть чистый UTC, или `12:00:00+03:00` если с `-api QuickTimeUTC`).
5.  **Повторный запуск:**
    Запустите снова.
    *Ожидание:* В логе `Skipping ... Metadata already correct`. Файл не тронут (проверьте `ls -l` — время изменения не поменялось). python3
```

## Использование

Сделайте скрипт исполняемым:
```bash
chmod +x mp4_folder_date_fixer.py
```

### 1. Тестовый прогон (Dry Run)
Всегда начинайте с этого режима. Он покажет, какие файлы будут изменены, но не тронет их.
```bash
./mp4_folder_date_fixer.py --root /path/to/videos --dry-run --verbose
```

### 2. Реальный запуск (с лимитом)
Рекомендуется сначала проверить на небольшом количестве файлов.
```bash
./mp4_folder_date_fixer.py --root /path/to/videos --limit 5
```

### 3. Полный запуск
```bash
./mp4_folder_date_fixer.py --root /path/to/videos
```

### Аргументы
- `--root PATH`: (Обязательно) Путь к папке с видео.
- `--dry-run`: Только логирование, без изменений.
- `--limit N`: Остановиться после обработки N файлов.
- `--log PATH`: Путь к логу (по умолчанию `./mp4_date_fixer.log`).
- `--timezone`: Временная зона (по умолчанию `Europe/Moscow`).

## Технические детали

### Какие теги меняются?
Скрипт устанавливает следующие теги на `YYYY:MM:DD 12:00:00+03:00` (с учетом конвертации в UTC для QuickTime тегов):
- `QuickTime:CreateDate` / `ModifyDate`
- `QuickTime:TrackCreateDate` / `TrackModifyDate`
- `QuickTime:MediaCreateDate` / `MediaModifyDate`
- `Keys:CreationDate` (для Apple устройств)

### Файловые времена (mtime/ctime)
- **mtime (Modified):** Устанавливается на 12:00 целевой даты.
- **atime (Accessed):** Устанавливается на 12:00 целевой даты.
- **ctime (Changed):** В Linux `ctime` обновляется ядром автоматически при любой записи метаданных. **Его невозможно установить в прошлое** без изменения системных часов. Поэтому `ctime` будет равен времени запуска скрипта.

### Логика конфликтов
Если `QuickTime:CreateDate` уже соответствует целевой дате (12:00 MSK), файл считается корректным и пропускается (даже если другие теги отличаются). Это позволяет сохранить историю редактирования, если она была.


### Как протестировать (Checklist)

1.  **Подготовка:**
    Создайте структуру:
    ```text
    test_folder/
      ├── 2023-01-01 New Year/
      │     └── video1.mp4
      └── NoDateFolder/
            └── video2.mp4
    ```
2.  **Dry Run:**
    Запустите с `--dry-run`.
    *Ожидание:* В логе написано `[DRY-RUN] Would execute...` для `video1.mp4`. `video2.mp4` пропущен (нет даты).
3.  **Запуск:**
    Запустите без флагов.
    *Ожидание:* `video1.mp4` обновлен. Появился лог `Success`.
4.  **Проверка:**
    Выполните `exiftool -G1 -a -s test_folder/2023-01-01\ New\ Year/video1.mp4`.
    *Ожидание:* `CreateDate` показывает время, эквивалентное 12:00 MSK (например, `09:00:00` если смотреть чистый UTC, или `12:00:00+03:00` если с `-api QuickTimeUTC`).
5.  **Повторный запуск:**
    Запустите снова.
    *Ожидание:* В логе `Skipping ... Metadata already correct`. Файл не тронут (проверьте `ls -l` — время изменения не поменялось).