# Документация для AI-агентов: Проект Image-Dedup

Этот документ предназначен для AI-агентов и разработчиков, чтобы обеспечить быстрое понимание архитектуры, ключевых компонентов и рабочих процессов проекта `image-dedup`.

## 1. Обзор Проекта

Проект `image-dedup` — это программный конвейер для поиска и группировки семантически похожих изображений. Он использует нейросетевую модель `CLIP` для преобразования изображений в векторные представления (эмбеддинги) и `FAISS` для эффективного поиска похожих векторов.

**Ключевые возможности:**
- **Индексация:** Рекурсивное сканирование директорий, вычисление эмбеддингов для изображений и сохранение их в базе данных.
- **Кластеризация:** Группировка изображений на основе косинусного сходства их эмбеддингов.
- **Ручной разбор:** GUI-приложение для просмотра кластеров и принятия решений об удалении дубликатов.
- **Идемпотентность:** Повторная индексация обрабатывает только новые или измененные файлы.

## 2. Архитектура и Компоненты

Проект состоит из следующих ключевых модулей:

- **`src/main.py`**:
  - **Назначение:** Точка входа приложения, использующая `Typer` для создания CLI.
  - **Команды:** `init`, `index`, `cluster`, `review`.

- **`src/config.py`**:
  - **Назначение:** Централизованное управление конфигурацией с помощью `Pydantic`.
  - **Ключевые параметры:** `DB_URL`, `CLIP_MODEL_NAME`, `BATCH_SIZE`, `SIMILARITY_THRESHOLD`.

- **`src/db.py`**:
  - **Назначение:** Определение схемы базы данных и управление сессиями.
  - **ORM:** `SQLAlchemy`.
  - **Основная модель:** `ImageRecord`, которая хранит путь к файлу, метаданные, эмбеддинг (`pgvector.Vector`) и статус обработки.

- **`src/indexer.py`**:
  - **Назначение:** Вычисление и сохранение эмбеддингов изображений.
  - **Процесс:**
    1. Сканирует директорию на наличие новых/измененных файлов.
    2. Использует `torch.utils.data.DataLoader` для пакетной обработки.
    3. Загружает модель `open_clip` для вычисления векторов.
    4. Сохраняет эмбеддинги в `ImageRecord.embedding`.

- **`src/clusterer.py`**:
  - **Назначение:** Группировка похожих изображений.
  - **Процесс:**
    1. Загружает все эмбеддинги из БД.
    2. Строит `faiss.IndexFlatIP` для быстрого поиска по косинусному сходству.
    3. Использует `index.range_search` для нахождения пар с высоким сходством.
    4. Строит граф (`networkx`) для поиска связных компонент (кластеров).
    5. Обновляет `ImageRecord.cluster_id` в БД.

- **`src/gui.py`**:
  - **Назначение:** Предоставляет `PyQt6` GUI для ручного разбора кластеров.
  - **Функционал:** Позволяет просматривать группы изображений и помечать дубликаты для удаления.

- **`docker-compose.yml`**:
  - **Назначение:** Конфигурация для запуска контейнера `PostgreSQL` с расширением `pgvector`.

## 3. Основные Сценарии Использования (Команды CLI)

Весь процесс работы с утилитой разделён на несколько команд, которые вызываются через `src/main.py`.

### `init`
- **Назначение:** Инициализация базы данных. Создаёт таблицы и активирует расширение `pgvector`.
- **Когда использовать:** Один раз при первоначальной настройке.

### `index /path/to/images`
- **Назначение:** Сканирование директории с изображениями, вычисление эмбеддингов и сохранение их в БД.
- **Ключевые флаги:**
  - `--limit N`: Ограничить количество обрабатываемых файлов. Полезно для отладки.
  - `--force`: Переиндексировать все файлы, даже если они не изменялись.
- **Процесс:**
  1. Находит все файлы изображений в указанной директории.
  2. Сравнивает `mtime` и размер файла с записями в БД, чтобы пропустить уже обработанные.
  3. Для новых или изменённых файлов вычисляет эмбеддинги с помощью `CLIP`.
  4. Сохраняет/обновляет запись в таблице `ImageRecord`.

### `cluster`
- **Назначение:** Группировка похожих изображений.
- **Процесс:**
  1. Загружает все эмбеддинги из БД.
  2. Использует `FAISS` для поиска пар изображений, сходство которых выше `SIMILARITY_THRESHOLD`.
  3. Строит граф связей и находит кластеры (связные компоненты).
  4. Присваивает `cluster_id` для сгруппированных изображений в БД.

### `review`
- **Назначение:** Запуск `PyQt6` GUI для ручного просмотра кластеров.
- **Функционал:**
  - Навигация по кластерам.
  - Просмотр изображений внутри каждого кластера.
  - Возможность пометить "лишние" изображения для последующего удаления (`to_delete=True`).

## 4. Работа с Кодом (Разработка и Тестирование)

### Установка зависимостей
Проект использует `pip` и `virtualenv` для управления зависимостями.
```bash
# Создание и активация виртуального окружения
python3 -m venv .venv
source .venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt
```

### Качество кода
Перед коммитом убедитесь, что код отформатирован и прошел проверку линтером.
```bash
# Активируйте виртуальное окружение, если еще не сделали этого
# source .venv/bin/activate

# Автоматическое исправление и форматирование
ruff check --fix .
ruff format .

# Проверка типов
mypy src
```

### Тестирование
Для запуска тестов используется `pytest`.
```bash
# Активируйте виртуальное окружение, если еще не сделали этого
# source .venv/bin/activate

# Запуск всех тестов
pytest

# Запуск тестов с отчетом о покрытии
pytest --cov=src --cov-report=term-missing
```

## 5. Схема Рабочего Процесса

Стандартный процесс работы с утилитой выглядит следующим образом:

1.  **Инициализация (однократно):**
    -   Запустите `python src/main.py init` для создания таблиц в базе данных.

2.  **Индексация:**
    -   Запустите `python src/main.py index /path/to/your/images`.
    -   Программа просканирует директорию, вычислит эмбеддинги для новых/измененных изображений и сохранит их в БД.

3.  **Кластеризация:**
    -   Запустите `python src/main.py cluster`.
    -   Утилита найдет группы похожих изображений и обновит поле `cluster_id` в базе данных.

4.  **Ручной разбор:**
    -   Запустите `python src/main.py review`.
    -   В открывшемся GUI просмотрите предложенные кластеры и отметьте дубликаты для удаления.

5.  **(Опционально) Удаление:**
    -   Напишите собственный скрипт или выполните SQL-запрос для удаления файлов, помеченных как `to_delete=True`.
