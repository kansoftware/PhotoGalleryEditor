# AGENTS.md: Инструкции для AI-агента

Этот файл определяет ключевые архитектурные решения, правила и команды для проекта `PhotoGalleryEditor`.

## 1. Обзор проекта

`PhotoGalleryEditor` — это утилита с интерфейсом командной строки (CLI) на Python для управления медиа-коллекцией. Она объединяет три основные функции:

1.  **Сортировка медиафайлов** по дате (`manage sort`).
2.  **Исправление метаданных** для видео (`manage fix-mp4-date`).
3.  **Поиск и удаление дубликатов** изображений с помощью AI (`duplicates`).

Проект использует `Typer` для создания вложенных команд.

## 2. Сборка и Тестирование (Build & Test)

**Настройка окружения:**
Проект использует `pip` и `virtualenv`.

1.  Создание и активация виртуального окружения:
    
    ```bash
    python3 -m venv .venv
    . .venv/bin/activate
    ```

2.  Установка зависимостей:
    
    ```bash
    pip install -r requirements.txt
    ```

**Запуск тестов:**
Тесты написаны с использованием `pytest`. Для запуска выполните:
```bash
pytest
```
*Примечание: Тесты в основном покрывают логику поиска дубликатов. Новые тесты должны следовать той же структуре.*

**Внешние зависимости:**
- `ffmpeg` и `exiftool` должны быть установлены в системе для работы подкоманд `manage`.
- `docker-compose` необходим для запуска базы данных `PostgreSQL` для модуля `duplicates`.

## 3. Стиль Кода (Code Style)

Проект использует `ruff` для форматирования и линтинга.

- **Форматирование:** Перед коммитом всегда применяйте форматирование.
  
  ```bash
  ruff format .
  ```

- **Линтинг:** Код должен проходить проверку без ошибок.
  
  ```bash
  ruff check .
  ```

- **Ключевые правила:**
    - Длина строки: 88 символов.
    - Импорты должны быть отсортированы (isort-совместимо).
    - Всегда используйте аннотации типов (type hints).

## 4. Архитектура и Паттерны

- **Точка входа:** `src/main.py`.
- **Структура CLI:** Приложение построено на `Typer` с использованием вложенных команд (sub-apps):
    - `manage`: Команды для работы с файлами.
    - `duplicates`: Команды для поиска дубликатов.
- **Конфигурация:** Настройки для модуля `duplicates` управляются через `src/config.py` и могут быть переопределены с помощью переменных окружения (используется `pydantic-settings`).
- **База данных:** Модуль `duplicates` использует `PostgreSQL` с расширением `pgvector` для хранения эмбеддингов изображений. ORM — `SQLAlchemy`.
- **Импорты:** Внутри пакета `src` используйте относительные импорты (например, `from .db import init_db`).

## 5. Важные замечания

- Не храните секреты или API-ключи в коде. Используйте `.env` файлы для конфигурации.
- При добавлении новых зависимостей не забывайте обновлять `requirements.txt`.
- Логика каждого CLI-модуля должна быть инкапсулирована в своей функции или классе, чтобы `main.py` оставался чистым и отвечал только за интерфейс.
